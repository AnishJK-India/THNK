---
sidebar_position: 3
description: Dans cette troisi√®me partie du tutoriel d√©butant, d√©couvrons comment adapter votre jeu √† THNK.
keywords:
  - comment d√©marrer
  - jeu de plateforme
  - apprendre
  - animation
  - messages
  - √©v√©nements
  - client
  - joueur
  - contr√¥les
  - THNK
  - p2p
  - multijoueur
  - GDevelop
---

# Utiliser THNK pour un jeu de plateforme

## THNK n'est pas un framework de jeux multijoueur.

THNK est avant tout un kit de cr√©ation de jeux en architecture autoritaire. C'est une fa√ßon de construire des jeux qui suivent l'architecture client-serveur qui fait autorit√©. Un jeu construit avec THNK est pr√™t √† √™tre transform√© en multijoueur par une extension d'adaptateur, mais n'est pas un jeu intrins√®quement multijoueur.

Par cons√©quent, un aper√ßu du jeu sans adaptateur fonctionnera en mode solo. Lorsque vous construisez avec THNK, vous commencez par construire le jeu en mode solo. Ensuite vous ajouterez le multijoueur avec les extensions d'adaptateur.

Commen√ßons √† construire en mode solo!

## Cr√©ons un jeu de plateforme‚ÄØ!

Tout d'abord, nous allons ajouter un personnage de jeu de plateforme (avec les contr√¥les par d√©faut) et quelques plateformes utilisant les comportements par d√©faut de GDevelop. Cela ressemble √† la fa√ßon dont vous le feriez dans GDevelop - rien de nouveau jusqu'√† pr√©sent !

<video
  title="well you probably already know how that works lol"
  width="100%"
  muted
  loop
  controls
>
  <source src="/webm/platformer/behaviors.webm" type="video/webm" />
  <p>
    Une vid√©o d'une sc√®ne GDevelop avec des objets contenant les comportements de personnage de jeu de plateforme et de plateforme
    
  </p>
</video>

Si vous lancez un aper√ßu, vous devriez √™tre en mesure de sauter sur vos plateformes.

## Ajouter des animations au joueur

Ajoutons des animations au joueur ! C'est une t√¢che assez basique dans GDevelop. Mais souvenez-vous, dans THNK, les √©v√©nements doivent √™tre dans une des deux cat√©gories : Serveur ou Client. Avant d'ajouter des animations, nous devons d√©cider √† quelle section elles appartiennent.

Lorsque vous ajoutez des √©v√©nements √† votre jeu, vous devez toujours vous poser quelques questions :

-   Exigent-t-ils des informations que le client ne devrait pas conna√Ætre‚ÄØ?
-   Est-ce quelque chose qui affecte d'autres joueurs ?

Dans notre cas, les animations du joueur¬†:

-   Utilise la position des joueurs visibles √† l'√©cran (pour d√©terminer s'ils se d√©placent ou pas), informations que le client a dans tous les cas
-   N'affecte que l'aspect du jeu local et non celui des autres joueurs

Cela devrait donc √™tre dans la section client‚ÄØ!

<video
  title="C'EST UNE PrStain de REFFERENCE A HARRY POTTER?!?"
  width="100%"
  muted
  loop
  controls
>
  <source src="/webm/platformer/animations.webm" type="video/webm" />
  <p>
    Une vid√©o du "Choixpeau" de Harry Potter d√©clarant que ces √©v√©nements doivent √™tre mis sous les √©v√©nements clients.
  </p>
</video>

:::note Pourquoi ne puis-je pas le mettre dans les √©v√©nements du serveur ?

Techniquement, il n'est pas obligatoire d'inclure les animations dans les √©v√©nements client, mais, en pratique, c'est souvent une meilleure id√©e. Si elles √©taient sur le serveur, elles devraient √™tre synchronis√©es avec les clients. Cela pose probl√®me pour deux raisons¬†:

1.  C'est mauvais pour la bande passante - chaque fois qu'une animation change, le changement devrait √™tre envoy√© aux clients. Avec beaucoup d'objets et de clients, cela peut surcharger rapidement le r√©seau en transmettant quelque chose que le client conna√Æt d√©j√†, car il peut d√©j√† le d√©duire du mouvement d'autres objets. Vous devriez toujours essayer de r√©duire au minimum la communication entre le client et le serveur pour √©viter des probl√®mes sur des connexions √† faible vitesse.

2.  Il pourrait en r√©sulter que les animations ne correspondent pas √† ce qui est affich√© √† l'√©cran. √âtant donn√© que le serveur g√©rerait les animations, les animations ne seraient mises √† jour que sur les ticks du serveur, qui peuvent √™tre r√©gl√©es √† un taux inf√©rieur √† celui de la fr√©quence de rendu des images. Pendant quelques images, l'animation pourrait ne pas correspondre √† ce √† quoi vous vous attendiez, jusqu'√† ce que le serveur envoie une mise √† jour.

:::

## Adaptation du jeu de plate-forme pour le multijoueur

### Donner √† chaque client un objet joueur

Nous avons maintenant un simple jeu de plateforme solo avec des animations. Ajoutons un peu de multijoueur !
D'abord, nous devons dire √† THNK ce qu'il faut faire quand un autre joueur se connecte. Nous voulons que chaque joueur ait son propre personnage. Par cons√©quent, √† chaque connexion de joueur, nous devons lui cr√©er un objet de personnage, et le supprimer lorsque le joueur se d√©connecte. Nous allons lier l'objet au joueur : cela nous permettra de savoir quelle instance appartient √† quel joueur. De cette fa√ßon, nous saurons quelle instance du personnage de plateforme supprimer quand un joueur quitte la partie.

:::tip S√©lection du joueur

Vous avez peut-√™tre remarqu√© que vous ne sp√©cifiez pas √† quel joueur vous liez l'objet. Cela est d√ª au fait que THNK l'a d√©j√† fait : l'√©v√©nement "connexion" choisit le joueur qui se connecte pour √™tre utilis√© par les actions suivantes.

Si vous souhaitez lier un objet (ou g√©n√©ralement utiliser une action THNK qui utilise le joueur choisi) sur un autre joueur sp√©cifique ou en dehors d'une condition de s√©lection du joueur, vous pouvez utiliser l'action "Choisir un joueur" pour sp√©cifier le joueur √† choisir.

:::

:::info

Si vous aviez une instance initiale du joueur sur la sc√®ne, vous devriez la supprimer ! Cette instance serait juste un "zombie" - puisqu'elle n'est li√©e √† aucun joueur, aucun ne sera capable de le contr√¥ler...

:::

√âvidemment, les connexions et les d√©connexions doivent √™tre g√©r√©s par le serveur, c'est pourquoi nous devons les inclure dans les √©v√©nements du serveur.

<video title="ooo that's pretty easy" width="100%" muted loop controls>
  <source src="/webm/platformer/connections.webm" type="video/webm" />
  <p>Une vid√©o montrant l'ajout des √©v√©nements mentionn√©s.</p>
</video>

Puisque nous voulons que les clients puissent voir les objets de joueur, nous avons besoin qu'ils soient synchronis√©s du serveur √† tous les clients. Pour ce faire, c'est tr√®s simple - il suffit d'ajouter le comportement de synchronisation (de THNK) √† l'objet de votre joueur !

<video title="woa c si rapid" width="100%" muted loop controls>
  <source src="/webm/platformer/add-sync-behavior.webm" type="video/webm" />
  <p>Une vid√©o montrant l'ajout du comportement "Synchronisation".</p>
</video>

### Ajout de contr√¥les de joueur pour les clients

Alors que le joueur peut √™tre correctement contr√¥l√© en mode solo tel quel, les mouvements ne se synchroniseraient pas avec les autres clients en mode multijoueur, malgr√© le comportement de synchronisation. _Pourquoi ?_

La raison en est que les comportements fonctionnent √† la fois sur le client et sur le serveur. Puisque le serveur ne peut pas lire une commande d'un joueur, c'est une t√¢che du client. Le comportement de plateforme ne recevra aucune commande en ce qui concerne le serveur, et donc les autres clients ne verront aucun mouvement.

Les clients peuvent toujours d√©placer leur propre personnage car le client a acc√®s aux commandes du joueur et ex√©cute √©galement le comportement de plateforme. Seul le serveur peut d√©placer des objets pour tous les joueurs, donc ce mouvement ne sera pas synchronis√©.

Dans THNK, toute interaction avec l'√©tat du jeu, du mouvement du joueur √† l'utilisation d'un objet dans l'inventaire, doit √™tre envoy√©e en tant que commande du client vers le serveur. C'est alors au serveur de valider/traiter la commande et de mettre √† jour l'√©tat du jeu en cons√©quence, pour que tout le monde puisse le voir.

Dans ce cas, tout ce que nous avons √† faire est d'envoyer les commandes des clients et de les transmettre au comportement de plateforme. Le comportement de plateforme traitera la fa√ßon dont l'objet doit se d√©placer et mettra √† jour sa position automatiquement, en s'occupant de la partie "validation et mise √† jour de l'√©tat du jeu" de la gestion des messages.

#### La mani√®re na√Øve

Envoyer une commande depuis le client et la recevoir sur le serveur peut √™tre fait avec l'action et les conditions correspondantes :

<video
  title="C'est la mani√®re na√Øve, ne faites pas √ßa chez vous, les enfants!"
  width="100%"
  muted
  loop
  controls
>
  <source src="/webm/platformer/messages.webm" type="video/webm" />
  <p>
    Une vid√©o de l'ajout des √©v√©nements pour envoyer et recevoir des messages.
  </p>
</video>

#### La m√©thode intelligente

Nous avons ces √©v√©nements jusqu'√† pr√©sent:

![Nos √©v√©nements √©crits jusqu'ici](./img/platformer/messages.png "Oooh voila nos √©v√©nements jusqu'ici üòé")

Ils peuvent techniquement fonctionner, mais... ils sont imparfaits.

La r√©ception d'√©v√©nements par un √©v√©nement standard est plus lisible, mais cela ne permet de traiter qu'un message par tick du serveur, √©tant donn√© que la condition n'est v√©rifi√©e qu'une seule fois. Laisser des messages non g√©r√©s et √™tre trait√©s lors du prochain tick risque de causer des probl√®mes si de nombreux joueurs envoient beaucoup de messages. Pour traiter tous les messages re√ßus en un seul tick du serveur, utilisez un √©v√©nement "tant que" pour g√©rer les √©v√©nements alors que certains sont disponibles pour √™tre trait√©s:

<video title="While event underrated smh" width="100%" muted loop controls>
  <source src="/webm/platformer/while.webm" type="video/webm" />
  <p>
    Une vid√©o montrant le transfert des conditions et actions d'un √©v√©nement standard √† un √©v√®nement "tant que".
  </p>
</video>

Le deuxi√®me probl√®me est le type de message que nous envoyons. Lors de l'envoi de messages, vous devriez toujours garder quelques √©l√©ments √† l'esprit.

1.  La connexion peut √™tre instable, ce qui peut occasionner des retards dans les messages
2.  Le trafic entre le serveur et le client devrait √™tre aussi minimal que possible, afin de ne pas utiliser plus de bande passante que disponible

Ces √©v√©nements sont envoy√©s √† chaque image durant laquelle une touche est press√©e. C'est beaucoup de messages, et cela prend beaucoup de bande passante!
Si pour une raison quelconque, un message n'est pas re√ßu par le serveur avant chaque tick, p. ex. en raison de d√©connexions courtes en raison de l'instabilit√© de la connexion, alors, en ce qui concerne le serveur, c'est comme si le joueur pressait et relachait le bouton alors qu'en fait, ils le maintiennent appuy√©.

Pour corriger cela, prenons une autre approche: Nous enverrons un unique message lorsque nous appuierons sur le bouton et un autre, lorsque nous le rel√¢cherons. De cette fa√ßon, nous pouvons envoyer moins de messages, et si la connexion est instable, le serveur supposera que le client continue √† faire ce qu'il faisait au lieu de supposer qu'il a arr√™t√© de faire quoi que ce soit.

import smartInput1 from "./img/platformer/smart-input-1.png";
import smartInput2 from "./img/platformer/smart-input-2.png";
import smartInput3 from "./img/platformer/smart-input-3.png";
import smartInput4 from "./img/platformer/smart-input-4.png";

<div>
  {/* prettier-ignore */}
  <div style={{ display: "flex", flexWrap: "wrap", gap: "1vh", justifyContent: "center" }}>
    <img src={smartInput1} width="50%" style={{ alignSelf: "center", minWidth: "300px" }} />
    <img src={smartInput2} width="50%" style={{ alignSelf: "center", minWidth: "300px" }} />
    <img src={smartInput3} width="50%" style={{ alignSelf: "center", minWidth: "300px" }} />
    <img src={smartInput4} width="50%" style={{ alignSelf: "center", minWidth: "300px" }} />
  </div>
</div>

Cette solution est plus complexe, mais offrira une bien meilleure exp√©rience aux joueurs.

:::caution

Bien s√ªr, nous le faisons ici que parce que cela a du sens pour une commande de mouvement continue. Par exemple, l'utilisation d'une potion dans un RPG ne devrait √™tre trait√©e qu'une seule fois lorsque cela est demand√©. Consommer continuellement des potions √† chaque tick du serveur tant que le client ne demande pas d'arr√™ter n'est pas une bonne m√©canique de jeu :p

:::
